!function(e){e.extend(e.fn,{_opt:{imgTar:"#uploadfile",placeholader:"请输入内容",validHtml:["<br/>"],limitSize:5,showServer:!1,uploadUrl:"",breaks:!1,compressSize:2,data:{},uploadField:"file",formInputId:"target",beforeUpload:{},uploadSuccess:{},uploadError:{}},artEditor:function(t){var a=this,r={"-webkit-user-select":"text","user-select":"text","overflow-y":"auto","text-break":"brak-all",outline:"none",cursor:"text"};e(this).css(r).attr("contenteditable",!0),a._opt=e.extend(a._opt,t);try{e(a._opt.imgTar).on("change",function(e){var t=e.target.files[0];if(e.target.value="",Math.ceil(t.size/1024/1024)>a._opt.limitSize)return a._opt.uploadError("文件太大，上传失败");var r=new FileReader;r.readAsDataURL(t),r.onload=function(e){var r=e.target.result,o=new Image;if(o.src=e.target.result,a._opt.compressSize&&Math.ceil(t.size/1024/1024)>a._opt.compressSize&&setTimeout(function(){r=a.compressHandler(o)},10),a._opt.beforeUpload&&"function"==typeof a._opt.beforeUpload&&(r=a._opt.beforeUpload(r)),a._opt.showServer)return void a.upload(r);var i='<img src="'+r+'" style="max-width:100%;" />';a.insertImage(i)}}),a.placeholderHandler(),a.pasteHandler()}catch(e){console.log(e)}a._opt.formInputId&&e("#"+a._opt.formInputId)[0]&&e(a).on("input",function(){e("#"+a._opt.formInputId).val(a.getValue())}),e(this).on("input click",function(){return setTimeout(function(){var e=window.getSelection?window.getSelection():document.selection;a.range=e.createRange?e.createRange():e.getRangeAt(0)},10),!1}),!/firefox/.test(navigator.userAgent.toLowerCase())&&this._opt.breaks&&e(this).keydown(function(e){if(13===e.keyCode)return document.execCommand("insertHTML",!1,"<br/><br/>"),!1})},compressHandler:function(e){var t,a=document.createElement("canvas"),r=a.getContext("2d"),o=document.createElement("canvas"),i=o.getContext("2d"),n=(e.src.length,e.width),l=e.height;(t=n*l/4e6)>1?(t=Math.sqrt(t),n/=t,l/=t):t=1,a.width=n,a.height=l,r.fillStyle="#fff",r.fillRect(0,0,a.width,a.height);var s;if((s=n*l/1e6)>1){s=~~(Math.sqrt(s)+1);var c=~~(n/s),p=~~(l/s);o.width=c,o.height=p;for(var d=0;d<s;d++)for(var u=0;u<s;u++)i.drawImage(e,d*c*t,u*p*t,c*t,p*t,0,0,c,p),r.drawImage(o,d*c,u*p,c,p)}else r.drawImage(e,0,0,n,l);var g=a.toDataURL("image/jpeg",.1);return o.width=o.height=a.width=a.height=0,g},upload:function(t){var a=this,r=a._opt.uploadField||"uploadfile",o=e.extend(a._opt.data,{});o[r]=t,e.ajax({url:a._opt.uploadUrl,type:"post",data:o,cache:!1,success:function(e){var t=a._opt.uploadSuccess(e);if(t){var r='<img src="'+t+'" style="max-width:100%;" />';a.insertImage(r)}else a._opt.uploadError(e.status)},error:function(e){a._opt.uploadError(e.status)}})},insertImage:function(t){e(this).focus();var a,r=window.getSelection?window.getSelection():document.selection;if(this.range?(a=this.range,this.range=null):a=r.createRange?r.createRange():r.getRangeAt(0),window.getSelection){a.collapse(!1);for(var o=a.createContextualFragment(t),i=o.lastChild;i&&"br"==i.nodeName.toLowerCase()&&i.previousSibling&&"br"==i.previousSibling.nodeName.toLowerCase();){var n=i;i=i.previousSibling,o.removeChild(n)}a.insertNode(a.createContextualFragment("<br/>")),a.insertNode(o),i&&(a.setEndAfter(i),a.setStartAfter(i)),r.removeAllRanges(),r.addRange(a)}else a.pasteHTML(t),a.collapse(!1),a.select();this._opt.formInputId&&e("#"+this._opt.formInputId)[0]&&e("#"+this._opt.formInputId).val(this.getValue())},pasteHandler:function(){var t=this;e(this).on("paste",function(a){console.log(a.clipboardData.items);var r=e(this).html();console.log(r),valiHTML=t._opt.validHtml,r=r.replace(/_moz_dirty=""/gi,"").replace(/\[/g,"[[-").replace(/\]/g,"-]]").replace(/<\/ ?tr[^>]*>/gi,"[br]").replace(/<\/ ?td[^>]*>/gi,"  ").replace(/<(ul|dl|ol)[^>]*>/gi,"[br]").replace(/<(li|dd)[^>]*>/gi,"[br]").replace(/<p [^>]*>/gi,"[br]").replace(new RegExp("<(/?(?:"+valiHTML.join("|")+")[^>]*)>","gi"),"[$1]").replace(new RegExp('<span([^>]*class="?at"?[^>]*)>',"gi"),"[span$1]").replace(/<[^>]*>/g,"").replace(/\[\[\-/g,"[").replace(/\-\]\]/g,"]").replace(new RegExp("\\[(/?(?:"+valiHTML.join("|")+"|img|span)[^\\]]*)\\]","gi"),"<$1>"),/firefox/.test(navigator.userAgent.toLowerCase())||(r=r.replace(/\r?\n/gi,"<br>")),e(this).html(r)})},placeholderHandler:function(){var t=this,a=/<img\s*([\w]+=(\"|\')([^\"\']*)(\"|\')\s*)*\/?>/;e(this).on("focus",function(){e.trim(e(this).text())===t._opt.placeholader&&e(this).html("")}).on("blur",function(){e.trim(e(this).text())||a.test(e(this).html())||e(this).html('<div class="placeholader" style="pointer-events: none;">'+t._opt.placeholader+"</div>")}),e.trim(e(this).text())||a.test(e(this).html())||e(this).html('<div class="placeholader" style="pointer-events: none;">'+t._opt.placeholader+"</div>")},getValue:function(){return e(this).html()},setValue:function(t){e(this).html(t)}})}(window.Zepto||window.jQuery);